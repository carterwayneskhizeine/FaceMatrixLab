# FaceMatrixLab

ä¸€ä¸ªåŸºäº MediaPipe å’Œ Open3D çš„å®æ—¶äººè„¸è·Ÿè¸ªä¸ 3D é¢å…·æ¸²æŸ“ç³»ç»Ÿï¼Œæ”¯æŒé«˜ç²¾åº¦äººè„¸å»ºæ¨¡ã€è¡¨æƒ…é©±åŠ¨å’Œ AR æ•ˆæœã€‚

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

FaceMatrixLab æ˜¯ä¸€ä¸ªå®Œæ•´çš„å®æ—¶äººè„¸åˆ†æä¸ 3D æ¸²æŸ“è§£å†³æ–¹æ¡ˆï¼Œèƒ½å¤Ÿï¼š

- ä½¿ç”¨ MediaPipe è¿›è¡Œ 468 ä¸ªé¢éƒ¨å…³é”®ç‚¹çš„å®æ—¶æ£€æµ‹
- åŸºäº `facial_transformation_matrix` å®ç°ç²¾ç¡®çš„ 3D å¤´éƒ¨å§¿æ€è·Ÿè¸ª
- æ”¯æŒå¤šç§æ¸²æŸ“æ¨¡å¼ï¼šçº¹ç†è´´å›¾ã€Lambert æè´¨ã€çº¿æ¡†æ˜¾ç¤º
- æä¾›ç›¸æœºè·ŸéšåŠŸèƒ½ï¼Œå®ç°åŠ¨æ€è§†è§’è°ƒæ•´
- æ”¯æŒæ•°æ®è®°å½•ä¸å¯¼å‡ºï¼Œä¾¿äºåç»­åˆ†æ

## âœ¨ æ ¸å¿ƒç‰¹æ€§

### ğŸ” äººè„¸æ£€æµ‹ä¸è·Ÿè¸ª
- **MediaPipe FaceLandmarker Tasks API**ï¼š468 ä¸ªé«˜ç²¾åº¦ 3D é¢éƒ¨å…³é”®ç‚¹
- **å§¿æ€çŸ©é˜µ**ï¼š4Ã—4 `facial_transformation_matrix` æä¾›å®Œæ•´çš„ TRS å˜æ¢
- **è¡¨æƒ…è¯†åˆ«**ï¼šæ”¯æŒ ARKit BlendShapesï¼ˆ52 ä¸ªè¡¨æƒ…æƒé‡ï¼‰
- **å®æ—¶æ€§èƒ½**ï¼š30 FPS ç¨³å®šè¿è¡Œï¼Œä½å»¶è¿Ÿå“åº”

### ğŸ¨ 3D æ¸²æŸ“å¼•æ“
- **å¤šæ¸²æŸ“æ¨¡å¼**ï¼š
  - åŸå§‹çº¹ç†å¤åˆ¶ï¼ˆä¿æŒçœŸå®é¢éƒ¨ç»†èŠ‚ï¼‰
  - Lambert æ¼«åå°„æè´¨ï¼ˆç‰©ç†å…‰ç…§æ¨¡å‹ï¼‰
  - åŒå…‰æº MatCap é£æ ¼ï¼ˆZBrush é£æ ¼æ¸²æŸ“ï¼‰
  - çº¿æ¡†æ¨¡å¼ï¼ˆäºšåƒç´ çº§ç»†çº¿æ”¯æŒï¼‰
- **é€è§†æŠ•å½±**ï¼šçœŸå® 50mm ç­‰æ•ˆç„¦è·ç›¸æœºæ¨¡æ‹Ÿ
- **åŠ¨æ€å…‰ç…§**ï¼šç¯å¢ƒå…‰ + ä¸»å…‰æº + è¡¥å…‰ç³»ç»Ÿ

### ğŸ“· ç›¸æœºç³»ç»Ÿ
- **ç›¸æœºè·Ÿéš**ï¼š3D è§†è§’è‡ªåŠ¨è·Ÿéšäººè„¸æ°´å¹³ç§»åŠ¨
- **é€è§†æ ¡æ­£**ï¼šæ”¯æŒçœŸå®ç›¸æœºå†…å‚æ ¡å‡†
- **æ·±åº¦æ§åˆ¶**ï¼šå¯è°ƒèŠ‚åŸºç¡€æ·±åº¦å’Œå˜åŒ–èŒƒå›´
- **å®½é«˜æ¯”ä¿®æ­£**ï¼šé’ˆå¯¹ 1280Ã—720 åˆ†è¾¨ç‡ä¼˜åŒ–

### ğŸ’¾ æ•°æ®è®°å½•
- **ä½ç½®æ•°æ®**ï¼šè‡ªåŠ¨ä¿å­˜ landmarks å’Œç›¸æœºä½ç½®
- **æ ¼å¼æ”¯æŒ**ï¼šJSON æ ¼å¼ï¼ŒåŒ…å«æ—¶é—´æˆ³å’Œå®Œæ•´å‚æ•°
- **æ‰¹é‡å¯¼å‡º**ï¼šæ”¯æŒ OBJ æ¨¡å‹å®æ—¶å¯¼å‡º

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

```
FaceMatrixLab/
â”œâ”€â”€ fml/                          # æ ¸å¿ƒæ¨¡å—
â”‚   â”œâ”€â”€ face_mask_renderer.py     # ä¸»æ¸²æŸ“å™¨ï¼ˆ3D é¢å…· + ARï¼‰
â”‚   â”œâ”€â”€ face_landmarker_camera.py # äººè„¸æ£€æµ‹ä¸»æ§ç¨‹åº
â”‚   â”œâ”€â”€ face_warper.py            # æ ¸å¿ƒæ¸²æŸ“å¼•æ“
â”‚   â”œâ”€â”€ precise_alignment_tool.py # ç²¾ç¡®å¯¹é½å·¥å…·
â”‚   â””â”€â”€ csv_to_obj_converter.py   # æ•°æ®æ ¼å¼è½¬æ¢
â”œâ”€â”€ obj/                          # 3D æ¨¡å‹èµ„æº
â”‚   â”œâ”€â”€ Andy_Wah_facemesh.obj     # ä¸»è¦äººè„¸æ¨¡å‹
â”‚   â”œâ”€â”€ canonical_face_model.obj  # MediaPipe æ ‡å‡†æ¨¡å‹
â”‚   â””â”€â”€ enhanced_texture.png      # é«˜è´¨é‡çº¹ç†è´´å›¾
â”œâ”€â”€ Camera-Calibration/           # ç›¸æœºæ ¡å‡†å·¥å…·
â””â”€â”€ pos_param_rec/               # æ•°æ®è®°å½•ç›®å½•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- Python 3.8+ (æˆ‘ä½¿ç”¨çš„æ˜¯3.11)
- Windows 10/11ï¼ˆæ¨èï¼‰
- æ‘„åƒå¤´è®¾å¤‡
- 4GB+ RAM

### å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

ä¸»è¦ä¾èµ–åŒ…ï¼š
```
mediapipe>=0.10.0
open3d>=0.17.0
opencv-python>=4.8.0
numpy>=1.21.0
```

### åŸºæœ¬ä½¿ç”¨

1. **å¯åŠ¨ 3D é¢å…·æ¸²æŸ“å™¨**ï¼š
```bash
python fml/face_mask_renderer.py
```

2. **ç›¸æœºæ ¡å‡†**ï¼ˆå¯é€‰ï¼‰ï¼š
```bash
cd Camera-Calibration
python calibration_GUI.py
```

## ğŸ® æ§åˆ¶è¯´æ˜

### é¢å…·æ¸²æŸ“å™¨æ§åˆ¶é”®

| æŒ‰é”® | åŠŸèƒ½ |
|------|------|
| **B** | åˆ‡æ¢æ‘„åƒæœºèƒŒæ™¯æ˜¾ç¤º |
| **C** | åˆ‡æ¢é¢å…·é¢œè‰² |
| **1-6** | ç›´æ¥é€‰æ‹©é¢å…·é¢œè‰² |
| **T** | åˆ‡æ¢çº¹ç†è´´å›¾/ç»Ÿä¸€é¢œè‰²æ¨¡å¼ |
| **L** | åˆ‡æ¢åŸå§‹ landmarks æ˜¾ç¤º |
| **F** | åˆ‡æ¢ç›¸æœºè·ŸéšåŠŸèƒ½ |
| **E** | å¯¼å‡ºå½“å‰å®æ—¶ 3D æ¨¡å‹ |
| **Q** | é€€å‡ºç¨‹åº |

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### MediaPipe æ•°æ®æµ

ç³»ç»Ÿå¤„ç†ä¸‰ç±»æ ¸å¿ƒæ•°æ®ï¼š

1. **`face_landmarks`**ï¼ˆ468Ã—3ï¼‰ï¼š
   - å½’ä¸€åŒ–å±å¹•åæ ‡ (x, y âˆˆ [0,1])
   - ç›¸å¯¹æ·±åº¦å€¼ (z)
   - æ”¯æŒè¡¨æƒ…å˜åŒ–æ•æ‰

2. **`facial_transformation_matrix`**ï¼ˆ4Ã—4ï¼‰ï¼š
   ```
   [R11 R12 R13 Tx]    # æ—‹è½¬çŸ©é˜µ + Xå¹³ç§»
   [R21 R22 R23 Ty]    # æ—‹è½¬çŸ©é˜µ + Yå¹³ç§»  
   [R31 R32 R33 Tz]    # æ—‹è½¬çŸ©é˜µ + Zå¹³ç§»
   [0   0   0   1 ]    # é½æ¬¡åæ ‡
   ```
   - å•ä½ï¼šæ¯«ç±³ï¼ˆmmï¼‰
   - æä¾›å®Œæ•´çš„ 3D å§¿æ€ä¿¡æ¯

3. **`face_blendshapes`**ï¼ˆ52 æƒé‡ï¼‰ï¼š
   - ARKit å…¼å®¹çš„è¡¨æƒ…æƒé‡
   - æ”¯æŒç²¾ç»†è¡¨æƒ…é©±åŠ¨

### æ¸²æŸ“ç®¡çº¿

```
è¾“å…¥å¸§ â†’ MediaPipeæ£€æµ‹ â†’ åæ ‡å˜æ¢ â†’ ä¸‰è§’å‰–åˆ† â†’ é€ä¸‰è§’å½¢æ¸²æŸ“ â†’ åå¤„ç† â†’ è¾“å‡º
```

**å…³é”®ç®—æ³•**ï¼š
- **Lambert æ¼«åå°„**ï¼š`I = Ia + Id Ã— max(0, NÂ·L)`
- **åŒå…‰æºç³»ç»Ÿ**ï¼šä¸»å…‰æº + æ­£é¢è¡¥å…‰ + Fresnel è¾¹ç¼˜å…‰
- **äºšåƒç´ çº¿æ¡†**ï¼šé€æ˜åº¦æ¨¡æ‹Ÿç»†çº¿æ•ˆæœ
- **è¾¹ç¼˜å¹³æ»‘**ï¼šåŒè¾¹æ»¤æ³¢ + è·ç¦»å˜æ¢

### ç›¸æœºè·Ÿéšç®—æ³•

```python
# è®¡ç®—äººè„¸æ°´å¹³ä¸­å¿ƒ
face_center_x = (min_x + max_x) / 2.0

# å½’ä¸€åŒ–åç§»é‡
offset_normalized = (face_center_x - screen_center_x) / screen_center_x

# å¹³æ»‘ç›¸æœºç§»åŠ¨
target_offset = offset_normalized * sensitivity
current_offset = lerp(current_offset, target_offset, smoothing_factor)
```

## ğŸ”§ é…ç½®å‚æ•°

### æ¸²æŸ“å‚æ•°

```python
# åŸºæœ¬è®¾ç½®
render_width = 1280          # æ¸²æŸ“å®½åº¦
render_height = 720          # æ¸²æŸ“é«˜åº¦
fps_target = 30              # ç›®æ ‡å¸§ç‡

# ç›¸æœºè·Ÿéš
enable_camera_following = True    # å¯ç”¨ç›¸æœºè·Ÿéš
camera_follow_smoothing = 0.3     # å¹³æ»‘ç³»æ•° (0-1)
camera_sensitivity = 2.0          # è·Ÿéšçµæ•åº¦
camera_max_offset = 5.0           # æœ€å¤§åç§»é™åˆ¶

# é€è§†æŠ•å½±
perspective_base_depth = 45.0     # åŸºç¡€æ·±åº¦ (cm)
perspective_depth_variation = 55.0 # æ·±åº¦å˜åŒ–èŒƒå›´
focal_length_mm = 50.0            # ç­‰æ•ˆç„¦è· (mm)
```

### æè´¨å‚æ•°

```python
# Lambert å…‰ç…§
ambient_intensity = 0.7           # ç¯å¢ƒå…‰å¼ºåº¦
main_diffuse_intensity = 0.8      # ä¸»å…‰æºå¼ºåº¦
front_diffuse_intensity = 0.4     # è¡¥å…‰å¼ºåº¦

# çº¿æ¡†æ¸²æŸ“
wireframe_thickness = 0.2         # çº¿æ¡†ç²—ç»†
wireframe_alpha = 0.7             # çº¿æ¡†é€æ˜åº¦
```

## ğŸ“ æ•°æ®æ ¼å¼

### Landmarks æ•°æ®ç»“æ„

```json
{
  "timestamp": "2024-01-01T12:00:00",
  "frame_count": 30,
  "screen_resolution": {
    "width": 1280,
    "height": 720
  },
  "original_landmarks": [
    {"x_000": 0.623, "y_000": 0.599, "z_000": -0.027},
    // ... 467 more points
  ],
  "pixel_landmarks": [
    {"x_000": 797.3, "y_000": 431.3, "z_000": -0.027},
    // ... 467 more points
  ],
  "camera_position": {
    "translation": {"x": 7.74, "y": -0.19, "z": -40.61},
    "rotation_matrix": [[0.995, -0.059, -0.083], ...],
    "intrinsic": {"fx": 1777.8, "fy": 1777.8, "cx": 640, "cy": 360}
  }
}
```

## ğŸ¨ è‡ªå®šä¹‰æ¨¡å‹

### æ¨¡å‹è¦æ±‚

1. **é¡¶ç‚¹é¡ºåº**ï¼šå¿…é¡»ä¸ MediaPipe canonical face model ä¸€è‡´
2. **æ‹“æ‰‘ç»“æ„**ï¼šä¿æŒ 468 ä¸ªå…³é”®é¡¶ç‚¹çš„ç´¢å¼•æ˜ å°„
3. **å•ä½**ï¼šä½¿ç”¨æ¯«ç±³ï¼ˆmmï¼‰ä½œä¸ºå•ä½
4. **UV åæ ‡**ï¼šå¦‚éœ€çº¹ç†è´´å›¾ï¼Œç¡®ä¿åŒ…å«æœ‰æ•ˆ UV

### çº¹ç†è´´å›¾è®¾ç½®

**æ–¹æ³• 1ï¼šä¿®æ”¹ MTL æ–‡ä»¶**
```mtl
newmtl face_mat
Ka 1 1 1
Kd 1 1 1
Ks 0 0 0
map_Kd enhanced_texture.png
```

**æ–¹æ³• 2ï¼šä»£ç ä¸­åŠ¨æ€åŠ è½½**
```python
tex_img = o3d.io.read_image("obj/enhanced_texture.png")
mesh.textures = [tex_img]
mesh.triangle_material_ids = o3d.utility.IntVector([0] * len(mesh.triangles))
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ¨¡å‹ä¸æ˜¾ç¤º**
   - æ£€æŸ¥ OBJ æ–‡ä»¶è·¯å¾„
   - ç¡®è®¤æ¨¡å‹åŒ…å«æœ‰æ•ˆé¡¶ç‚¹æ•°æ®
   - éªŒè¯ UV åæ ‡èŒƒå›´ [0,1]

2. **ç›¸æœºè·Ÿéšå¼‚å¸¸**
   - è°ƒæ•´ `camera_follow_smoothing` å‚æ•°
   - æ£€æŸ¥ landmarks æ£€æµ‹è´¨é‡
   - é‡æ–°æ ¡å‡†ç›¸æœºå†…å‚

3. **çº¹ç†æ˜¾ç¤ºé”™è¯¯**
   - ç¡®è®¤çº¹ç†æ–‡ä»¶æ ¼å¼ï¼ˆPNG/JPGï¼‰
   - æ£€æŸ¥ MTL æ–‡ä»¶è·¯å¾„å¼•ç”¨
   - éªŒè¯ triangle_material_ids è®¾ç½®

4. **æ€§èƒ½é—®é¢˜**
   - é™ä½æ¸²æŸ“åˆ†è¾¨ç‡
   - å…³é—­ä¸å¿…è¦çš„å¯è§†åŒ–é€‰é¡¹
   - ä½¿ç”¨ GPU åŠ é€Ÿï¼ˆå¦‚å¯ç”¨ï¼‰

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è°ƒè¯•è¾“å‡ºï¼š
```python
debug_mode = True
show_fps = True
show_landmarks = True
```

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

### å¼€å‘ç¯å¢ƒè®¾ç½®

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯ï¼š`git checkout -b feature/new-feature`
3. æäº¤æ›´æ”¹ï¼š`git commit -am 'Add new feature'`
4. æ¨é€åˆ†æ”¯ï¼š`git push origin feature/new-feature`
5. åˆ›å»º Pull Request

### ä»£ç è§„èŒƒ

- ä½¿ç”¨ Python PEP 8 æ ‡å‡†
- æ·»åŠ é€‚å½“çš„æ³¨é‡Šå’Œæ–‡æ¡£å­—ç¬¦ä¸²
- ä¿æŒå‡½æ•°åŠŸèƒ½å•ä¸€ä¸”æ¸…æ™°
- æäº¤å‰è¿è¡Œæµ‹è¯•ç”¨ä¾‹

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ™ è‡´è°¢

- [MediaPipe](https://mediapipe.dev/) - Google å¼€æºçš„æœºå™¨å­¦ä¹ æ¡†æ¶
- [Open3D](http://www.open3d.org/) - 3D æ•°æ®å¤„ç†åº“
- [OpenCV](https://opencv.org/) - è®¡ç®—æœºè§†è§‰åº“

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- æäº¤ GitHub Issue
- å‘é€é‚®ä»¶è‡³é¡¹ç›®ç»´æŠ¤è€…
- å‚ä¸ç¤¾åŒºè®¨è®º

---

**FaceMatrixLab** - è®©äººè„¸è·Ÿè¸ªä¸ 3D æ¸²æŸ“å˜å¾—ç®€å•è€Œå¼ºå¤§ï¼ 